{{ extends "layouts/main" }} {{ block script() }}
<script>
  let sortKey = "cpu";
  let sortDesc = true;
  let processes = [];
  let currentPage = 1;
  const itemsPerPage = 50;
  let ws = null;

  function connectWebSocket() {
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const wsUrl = `${protocol}//${window.location.host}/api/ws/processes`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function () {
      console.log("WebSocket connected for processes");
      document.getElementById("connection-status").textContent = "Connected";
      document.getElementById("connection-status").className =
        "badge badge-success badge-sm";
    };

    ws.onmessage = function (event) {
      try {
        const data = JSON.parse(event.data);
        processes = data.processes || [];
        updateSystemMetrics(data.total_cpu, data.total_memory);
        renderTable();
      } catch (error) {
        console.error("Error parsing WebSocket data:", error);
      }
    };

    ws.onclose = function () {
      console.log("WebSocket disconnected");
      document.getElementById("connection-status").textContent = "Disconnected";
      document.getElementById("connection-status").className =
        "badge badge-error badge-sm";
      // Reconnect after 3 seconds
      setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = function (error) {
      console.error("WebSocket error:", error);
    };
  }

  function updateSystemMetrics(totalCPU, totalMemory) {
    document.getElementById("total-cpu").textContent =
      totalCPU.toFixed(1) + "%";
    document.getElementById("total-memory").textContent =
      totalMemory.toFixed(1) + "%";

    // Update progress bars
    const cpuProgress = document.getElementById("cpu-progress");
    const memProgress = document.getElementById("mem-progress");

    cpuProgress.value = totalCPU;
    memProgress.value = totalMemory;

    // Update colors based on usage
    cpuProgress.className = `progress w-24 ${
      totalCPU > 80
        ? "progress-error"
        : totalCPU > 50
        ? "progress-warning"
        : "progress-success"
    }`;
    memProgress.className = `progress w-24 ${
      totalMemory > 80
        ? "progress-error"
        : totalMemory > 50
        ? "progress-warning"
        : "progress-success"
    }`;
  }

  function getStatusText(status) {
    const statusMap = {
      running: "text-success",
      sleeping: "text-info",
      stopped: "text-warning",
      zombie: "text-error",
    };
    const textClass = statusMap[status.toLowerCase()] || "text-base-content";
    return `<span class="font-mono font-semibold ${textClass}">${status.toUpperCase()}</span>`;
  }

  function getResourceBar(value, type) {
    const color =
      value > 80
        ? "progress-error"
        : value > 50
        ? "progress-warning"
        : "progress-success";
    return `
            <div class="flex items-center gap-2">
                <span class="text-sm font-mono w-12">${value.toFixed(1)}%</span>
                <progress class="progress ${color} w-16" value="${value}" max="100"></progress>
            </div>
        `;
  }

  function formatTime(timestamp) {
    if (!timestamp) return "N/A";
    return new Date(timestamp * 1000).toLocaleString();
  }

  async function killProcess(pid, name) {
    if (
      !confirm(`Are you sure you want to kill process "${name}" (PID: ${pid})?`)
    ) {
      return;
    }

    try {
      await fetch("/api/processes/kill", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pid: pid, name: name }),
      });
      showNotification("Process killed successfully", "success");
    } catch (error) {
      showNotification("Failed to kill process: " + error.message, "error");
    }
  }

  function renderTable() {
    const search = document.getElementById("search").value.toLowerCase();
    const statusFilter = document.getElementById("status-filter").value;

    let filtered = processes.filter((p) => {
      const matchesSearch =
        p.name.toLowerCase().includes(search) ||
        p.pid.toString().includes(search) ||
        (p.username && p.username.toLowerCase().includes(search));
      const matchesStatus =
        !statusFilter || p.status.toLowerCase() === statusFilter;
      return matchesSearch && matchesStatus;
    });

    filtered.sort((a, b) => {
      let valA = a[sortKey];
      let valB = b[sortKey];

      if (typeof valA === "string") {
        valA = valA.toLowerCase();
        valB = valB.toLowerCase();
      }

      if (valA < valB) return sortDesc ? 1 : -1;
      if (valA > valB) return sortDesc ? -1 : 1;
      return 0;
    });

    // Pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedProcesses = filtered.slice(startIndex, endIndex);

    // Render desktop table
    renderDesktopTable(paginatedProcesses);
    
    // Render mobile cards
    renderMobileCards(paginatedProcesses);

    // Update pagination info
    document.getElementById(
      "process-count"
    ).textContent = `Showing ${paginatedProcesses.length} of ${filtered.length} processes`;
    updatePagination(filtered.length);
  }

  function renderDesktopTable(paginatedProcesses) {
    const tbody = document.getElementById("proc-body");
    
    // Hide loading skeleton
    const loadingRows = tbody.querySelectorAll('[id^="loading-row"]');
    loadingRows.forEach(row => row.style.display = 'none');
    
    // Clear existing process rows
    const processRows = tbody.querySelectorAll('tr:not([id^="loading-row"])');
    processRows.forEach(row => row.remove());

    paginatedProcesses.forEach((p) => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-base-300 border-b border-base-content/10";
      tr.innerHTML = `
                <td class="font-mono text-base-content">${p.pid}</td>
                <td class="font-mono font-semibold text-base-content">${p.name}</td>
                <td class="font-mono">${getStatusText(p.status || "unknown")}</td>
                <td class="font-mono text-base-content/80">${(p.username || "N/A").substring(0, 8)}</td>
                <td class="font-mono">${getResourceBar(p.cpu, "cpu")}</td>
                <td class="font-mono">${getResourceBar(p.memory, "memory")}</td>
                <td class="font-mono text-base-content/60 truncate max-w-xs" title="${
                  p.command || "N/A"
                }">${p.command || "N/A"}</td>
                <td>
                    <button class="btn btn-error btn-xs font-mono" onclick="killProcess(${
                      p.pid
                    }, '${p.name}')" title="Kill Process">
                        ✕
                    </button>
                </td>
            `;
      tbody.appendChild(tr);
    });
  }

  function renderMobileCards(paginatedProcesses) {
    const container = document.getElementById("mobile-processes");
    container.innerHTML = "";

    paginatedProcesses.forEach((p) => {
      const card = document.createElement("div");
      card.className = "card bg-base-100 shadow-sm border border-base-content/10";
      card.innerHTML = `
        <div class="card-body p-4">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-mono font-bold text-base-content">${p.name}</h3>
              <p class="text-xs font-mono text-base-content/60">PID: ${p.pid} | User: ${p.username || "N/A"}</p>
            </div>
            <div class="flex items-center gap-2">
              ${getStatusText(p.status || "unknown")}
              <button class="btn btn-error btn-xs" onclick="killProcess(${p.pid}, '${p.name}')" title="Kill Process">
                ✕
              </button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <p class="text-xs text-base-content/60 mb-1">CPU Usage</p>
              ${getResourceBar(p.cpu, "cpu")}
            </div>
            <div>
              <p class="text-xs text-base-content/60 mb-1">Memory Usage</p>
              ${getResourceBar(p.memory, "memory")}
            </div>
          </div>
          <div>
            <p class="text-xs text-base-content/60 mb-1">Command</p>
            <p class="text-xs font-mono text-base-content/80 truncate" title="${p.command || "N/A"}">${p.command || "N/A"}</p>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById("pagination");
    const mobilePagination = document.getElementById("mobile-pagination");

    if (totalPages <= 1) {
      pagination.style.display = "none";
      mobilePagination.style.display = "none";
      return;
    }

    // Update desktop pagination
    updatePaginationContainer(pagination, totalPages, false);
    
    // Update mobile pagination
    updatePaginationContainer(mobilePagination, totalPages, true);
  }

  function updatePaginationContainer(container, totalPages, isMobile) {
    container.style.display = "flex";
    container.innerHTML = "";

    // Previous button
    const prevBtn = document.createElement("button");
    prevBtn.className = `btn btn-sm ${currentPage === 1 ? "btn-disabled" : ""}`;
    prevBtn.textContent = isMobile ? "‹" : "Previous";
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    };
    container.appendChild(prevBtn);

    // Page numbers (show fewer on mobile)
    const maxPages = isMobile ? 3 : 5;
    const startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
    const endPage = Math.min(totalPages, startPage + maxPages - 1);
    
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.className = `btn btn-sm ${i === currentPage ? "btn-active" : ""}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        currentPage = i;
        renderTable();
      };
      container.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement("button");
    nextBtn.className = `btn btn-sm ${currentPage === totalPages ? "btn-disabled" : ""}`;
    nextBtn.textContent = isMobile ? "›" : "Next";
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    };
    container.appendChild(nextBtn);
  }

  function sort(key) {
    if (sortKey === key) {
      sortDesc = !sortDesc;
    } else {
      sortKey = key;
      sortDesc = true;
    }
    currentPage = 1; // Reset to first page
    renderTable();
  }

  function showNotification(message, type) {
    // Simple notification - you can enhance this
    const alertClass = type === "success" ? "alert-success" : "alert-error";
    const alert = document.createElement("div");
    alert.className = `alert ${alertClass} fixed top-4 right-4 w-auto z-50`;
    alert.innerHTML = `<span>${message}</span>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
  }

  document.getElementById("search").addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });
  document.getElementById("status-filter").addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // Connect WebSocket for real-time updates
  connectWebSocket();

  // Cleanup on page unload
  window.addEventListener("beforeunload", function () {
    if (ws) {
      ws.close();
    }
  });
</script>
{{ end }} {{ block body() }}
<div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6 gap-4">
  <div>
    <h2 class="text-2xl lg:text-3xl font-bold">Process Manager</h2>
    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-2">
      <p class="text-base-content/70 text-sm" id="process-count">
        Loading processes...
      </p>
      <span class="badge badge-neutral badge-sm" id="connection-status"
        >Connecting...</span
      >
    </div>
  </div>
  <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
    <select class="select select-bordered select-sm" id="status-filter">
      <option value="">All Status</option>
      <option value="running">Running</option>
      <option value="sleeping">Sleeping</option>
      <option value="stopped">Stopped</option>
      <option value="zombie">Zombie</option>
    </select>
    <input
      type="text"
      placeholder="Search processes..."
      class="input input-bordered input-sm w-full sm:w-64"
      id="search"
    />
  </div>
</div>

<!-- System Metrics Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold text-sm text-base-content/70">
            Total CPU Usage
          </h3>
          <p class="text-2xl font-bold" id="total-cpu">0.0%</p>
        </div>
        <progress
          class="progress progress-success w-24"
          value="0"
          max="100"
          id="cpu-progress"
        ></progress>
      </div>
    </div>
  </div>
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold text-sm text-base-content/70">
            Total Memory Usage
          </h3>
          <p class="text-2xl font-bold" id="total-memory">0.0%</p>
        </div>
        <progress
          class="progress progress-info w-24"
          value="0"
          max="100"
          id="mem-progress"
        ></progress>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Card View -->
<div class="block lg:hidden space-y-3" id="mobile-processes">
  <!-- Mobile processes will be populated here -->
</div>

<!-- Desktop Table View -->
<div class="card bg-base-200 shadow-md border border-base-content/20 overflow-hidden hidden lg:block">
  <div class="overflow-x-auto">
    <table class="table table-zebra table-sm" style="font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; font-size: 13px;">
      <style>
        #proc-body td, #proc-body th { font-size: 13px !important; }
        #proc-body tr:hover { background-color: rgba(255,255,255,0.05) !important; }
      </style>
      <thead class="bg-base-300">
        <tr>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('pid')">
            PID
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('name')">
            PROCESS
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('status')">
            STAT
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('username')">
            USER
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('cpu')">
            %CPU
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="cursor-pointer hover:text-primary font-mono" onclick="sort('memory')">
            %MEM
            <svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
            </svg>
          </th>
          <th class="font-mono">COMMAND</th>
          <th class="font-mono">ACTION</th>
        </tr>
      </thead>
      <tbody id="proc-body" class="bg-base-200">
        <!-- Loading skeleton rows -->
        <tr id="loading-row-1" class="animate-pulse">
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-20"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-12"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-32"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
        </tr>
        <tr id="loading-row-2" class="animate-pulse">
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-24"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-12"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-40"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
        </tr>
        <tr id="loading-row-3" class="animate-pulse">
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-12"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-16"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-36"></div></td>
          <td><div class="h-3 bg-base-content/20 rounded w-8"></div></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="card-actions justify-center p-4">
    <div class="join" id="pagination" style="display: none">
      <!-- Pagination buttons populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Mobile Pagination -->
<div class="flex justify-center mt-4 lg:hidden">
  <div class="join" id="mobile-pagination" style="display: none">
    <!-- Mobile pagination buttons populated by JavaScript -->
  </div>
</div>
{{ end }}
