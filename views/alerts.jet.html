{{ extends "layouts/main" }}

{{ block script() }}
<style>
  .tab-active {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: inherit !important;
  }
</style>
<script>
  let alertRules = [];
  let alertHistory = [];
  let currentView = 'rules';
  let alertSocket = null;
  let currentPage = 1;
  const itemsPerPage = 20;

  // Simple toast notification function
  function showToast(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'} fixed top-4 right-4 w-96 z-50 shadow-lg`;
    toast.innerHTML = `
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 5000);
  }

  async function init() {
    await loadAlertRules();
    await loadAlertHistory();
    connectWebSocket();
    showHistoryView();
  }

  let reconnectAttempts = 0;
  const maxReconnectAttempts = 5;
  
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/api/ws/alerts`;
    
    alertSocket = new WebSocket(wsUrl);
    
    alertSocket.onopen = function() {
      console.log('Alerts WebSocket connected');
      reconnectAttempts = 0;
    };
    
    alertSocket.onmessage = function(event) {
      try {
        const update = JSON.parse(event.data);
        handleAlertUpdate(update);
      } catch (e) {
        console.error('Error parsing alert update:', e);
      }
    };
    
    alertSocket.onclose = function() {
      console.log('Alerts WebSocket disconnected');
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        console.log(`Reconnecting alerts... attempt ${reconnectAttempts}`);
        setTimeout(connectWebSocket, 3000);
      }
    };
    
    alertSocket.onerror = function(error) {
      console.error('Alerts WebSocket error:', error);
    };
  }

  function handleAlertUpdate(update) {
    
    switch(update.type) {
      case 'new_alert':
        // Add new alert to history
        if (update.alert) {
          alertHistory.unshift(update.alert);
          // Sort to maintain chronological order
          alertHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          if (currentView === 'history') {
            renderAlertHistory();
          }
          // Show toast notification
          showToast(`New ${update.alert.severity} alert: ${update.alert.type}`, 'warning');
        }
        break;
        
      case 'initial_alert':
        // Add initial alert to history without notification
        if (update.alert) {
          alertHistory.unshift(update.alert);
          // Sort to maintain chronological order
          alertHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          if (currentView === 'history') {
            renderAlertHistory();
          }
        }
        break;
        
      case 'rule_updated':
        // Update rule in the list
        if (update.rule) {
          const index = alertRules.findIndex(r => r.id === update.rule.id);
          if (index >= 0) {
            alertRules[index] = update.rule;
          } else {
            alertRules.push(update.rule);
          }
          if (currentView === 'rules') {
            renderAlertRules();
          }
        }
        break;
        
      case 'alert_resolved':
        // Refresh alert history
        if (currentView === 'history') {
          loadAlertHistory();
        }
        break;
    }
  }

  async function loadAlertRules() {
    try {
      const response = await fetch('/api/alerts/rules', {
        credentials: 'same-origin'
      });
      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error(response.statusText);
      }
      const data = await response.json();
      alertRules = Array.isArray(data) ? data : [];
      renderAlertRules();
    } catch (e) {
      console.error('Failed to load alert rules:', e);
      alertRules = [];
      renderAlertRules();
      showToast('Failed to load alert rules: ' + e.message, 'error');
    }
  }

  async function loadAlertHistory() {
    try {
      const response = await fetch('/api/alerts/history', {
        credentials: 'same-origin'
      });
      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error(response.statusText);
      }
      const data = await response.json();
      alertHistory = Array.isArray(data) ? data : [];
      // Sort by timestamp descending (newest first)
      alertHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      renderAlertHistory();
    } catch (e) {
      console.error('Failed to load alert history:', e);
      alertHistory = [];
      renderAlertHistory();
      showToast('Failed to load alert history: ' + e.message, 'error');
    }
  }

  function renderAlertRules() {
    const container = document.getElementById('rules-container');
    
    if (!container) {
      return;
    }
    
    if (!alertRules || alertRules.length === 0) {
      container.innerHTML = `
        <div class="text-center py-20">
          <div class="mb-6">
            <div class="w-24 h-24 mx-auto bg-base-200 rounded-full flex items-center justify-center mb-4">
              <svg class="w-12 h-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
              </svg>
            </div>
          </div>
          <h3 class="text-2xl font-bold text-base-content mb-2">No Alert Rules</h3>
          <p class="text-base-content/60 mb-6 max-w-md mx-auto">Get started by creating your first alert rule to monitor system metrics, log patterns, or exceptions.</p>
          <button class="btn btn-primary btn-lg gap-2" onclick="showCreateRuleModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Create First Alert Rule
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
        ${alertRules.map(rule => createRuleCard(rule)).join('')}
      </div>
    `;
  }

  function createRuleCard(rule) {
    return `
      <div class="card bg-base-100 shadow-sm border border-base-300 hover:shadow-md hover:border-primary/50 transition-all duration-200 h-full">
        <div class="card-body p-4 flex flex-col">
          <!-- Header -->
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full ${rule.enabled ? 'bg-success' : 'bg-error/60 border border-error'}"></div>
              <div class="badge badge-${getSeverityColor(rule.severity)} badge-sm px-2">${rule.severity.toUpperCase()}</div>
              ${!rule.enabled ? '<div class="badge badge-ghost badge-sm px-2">DISABLED</div>' : ''}
            </div>
            <div class="dropdown dropdown-end">
              <button class="btn btn-ghost btn-xs" tabindex="0">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                </svg>
              </button>
              <ul class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-box w-40 border z-10" tabindex="0">
                <li><a onclick="editRule('${rule.id}')" class="text-xs">Edit</a></li>
                <li><a onclick="toggleRule('${rule.id}', ${!rule.enabled})" class="text-xs">${rule.enabled ? 'Disable' : 'Enable'}</a></li>
                <li><a onclick="deleteRule('${rule.id}')" class="text-error text-xs">Delete</a></li>
              </ul>
            </div>
          </div>
          
          <!-- Title -->
          <h3 class="font-semibold text-base ${rule.enabled ? 'text-base-content' : 'text-base-content/50'} mb-2 line-clamp-2">${rule.name}</h3>
          
          <!-- Description -->
          <p class="text-base-content/60 text-sm mb-3 line-clamp-2 flex-grow">${rule.description || 'No description provided'}</p>
          
          <!-- Details -->
          <div class="space-y-2 text-xs">
            <div class="flex items-center justify-between">
              <span class="text-base-content/60">Type:</span>
              <span class="badge badge-outline badge-xs px-2 py-2">${getTypeDisplay(rule.type)}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-base-content/60">Email:</span>
              <span class="${rule.email_enabled ? 'text-success' : 'text-base-content/50'}">${rule.email_enabled ? '&#10003;' : '&#10007;'}</span>
            </div>
            ${rule.type === 'system_metric' ? `
              <div class="flex items-center justify-between">
                <span class="text-base-content/60">Threshold:</span>
                <span class="font-mono">${rule.threshold}%</span>
              </div>
            ` : ''}
            ${rule.type === 'log_pattern' || rule.type === 'exception_detection' ? `
              <div class="flex items-center justify-between">
                <span class="text-base-content/60">App:</span>
                <span class="truncate ml-2">${rule.app_filter || 'All'}</span>
              </div>
            ` : ''}
          </div>
          
          ${rule.last_triggered ? `
            <div class="mt-3 pt-3 border-t border-base-300">
              <div class="flex items-center gap-2 text-base-content/60">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span class="text-xs">Last Triggered: ${new Date(rule.last_triggered).toLocaleDateString()}</span>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  function getTypeDisplay(type) {
    const types = {
      'system_metric': 'System Metric',
      'log_pattern': 'Log Pattern',
      'exception_detection': 'Exception Detection',
      'service_status': 'Service Status'
    };
    return types[type] || type;
  }

  function renderAlertHistory() {
    const tbody = document.getElementById('alerts-body');
    const mobileContainer = document.getElementById('mobile-alerts');
    
    if (!tbody && !mobileContainer) {
      return;
    }
    
    if (!alertHistory || alertHistory.length === 0) {
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-base-content/60">No alerts recorded.</td></tr>';
      }
      if (mobileContainer) {
        mobileContainer.innerHTML = '<div class="text-center py-8 text-base-content/60">No alerts recorded.</div>';
      }
      updatePagination(0);
      return;
    }

    // Pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedAlerts = alertHistory.slice(startIndex, endIndex);

    // Render desktop table
    if (tbody) {
      tbody.innerHTML = paginatedAlerts.map(alert => `
        <tr class="hover:bg-base-50">
          <td class="text-sm">${new Date(alert.timestamp).toLocaleString()}</td>
          <td><span class="badge badge-${getSeverityColor(alert.severity)} badge-sm">${alert.severity || 'medium'}</span></td>
          <td class="font-medium">${alert.type}</td>
          <td class="max-w-xs">
            <div class="truncate" title="${alert.message}">${alert.message}</div>
          </td>
          <td>
            <span class="badge ${alert.resolved ? 'badge-success' : 'badge-error'} badge-outline badge-sm">
              ${alert.resolved ? 'Resolved' : 'Active'}
            </span>
          </td>
          <td>
            <div class="flex gap-1">
              ${!alert.resolved ? `<button class="btn btn-xs btn-success" onclick="resolveAlert(${alert.id})">Resolve</button>` : ''}
              <button class="btn btn-xs btn-ghost" onclick="viewAlertDetails(${alert.id})">Details</button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // Render mobile cards
    if (mobileContainer) {
      mobileContainer.innerHTML = paginatedAlerts.map(alert => createAlertCard(alert)).join('');
    }
    
    // Update pagination
    updatePagination(alertHistory.length);
  }
  
  function createAlertCard(alert) {
    return `
      <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body p-4">
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <span class="badge badge-${getSeverityColor(alert.severity)} badge-sm">${alert.severity || 'medium'}</span>
              <span class="badge ${alert.resolved ? 'badge-success' : 'badge-error'} badge-outline badge-sm">
                ${alert.resolved ? 'Resolved' : 'Active'}
              </span>
            </div>
            <div class="text-xs text-base-content/60">
              ${new Date(alert.timestamp).toLocaleString()}
            </div>
          </div>
          
          <div class="mb-3">
            <h3 class="font-medium text-base-content mb-1">${alert.type}</h3>
            <p class="text-sm text-base-content/80">${alert.message}</p>
          </div>
          
          <div class="flex gap-2">
            ${!alert.resolved ? `<button class="btn btn-xs btn-success" onclick="resolveAlert(${alert.id})">Resolve</button>` : ''}
            <button class="btn btn-xs btn-ghost" onclick="viewAlertDetails(${alert.id})">Details</button>
          </div>
        </div>
      </div>
    `;
  }

  function getSeverityColor(severity) {
    const colors = {
      'low': 'info',
      'medium': 'warning', 
      'high': 'error',
      'critical': 'error'
    };
    return colors[severity] || 'neutral';
  }

  function showRulesView() {
    currentView = 'rules';
    document.getElementById('rules-tab').classList.add('tab-active');
    document.getElementById('history-tab').classList.remove('tab-active');
    document.getElementById('rules-view').classList.remove('hidden');
    document.getElementById('history-view').classList.add('hidden');
  }



  function showCreateRuleModal() {
    const form = document.getElementById('rule-form');
    form.reset();
    document.getElementById('rule-id').value = '';
    document.getElementById('rule-modal-title').textContent = 'Create Alert Rule';
    
    // Reset form visibility
    updateConditionFields();
    
    document.getElementById('rule-modal').checked = true;
  }

  async function saveRule() {
    const form = document.getElementById('rule-form');
    const formData = new FormData(form);
    
    const ruleData = {
      id: formData.get('id') || undefined,
      name: formData.get('name'),
      description: formData.get('description'),
      type: formData.get('type'),
      severity: formData.get('severity'),
      enabled: formData.has('enabled'),
      email_enabled: formData.has('email_enabled')
    };

    // Add type-specific fields
    if (ruleData.type === 'system_metric') {
      ruleData.condition = formData.get('condition');
      ruleData.threshold = parseFloat(formData.get('threshold')) || 0;
      ruleData.log_pattern = '';
      ruleData.app_filter = '';
      ruleData.log_filter = '';
    } else if (ruleData.type === 'log_pattern' || ruleData.type === 'exception_detection') {
      ruleData.condition = '';
      ruleData.threshold = 0;
      ruleData.log_pattern = formData.get('log_pattern') || '';
      ruleData.app_filter = formData.get('app_filter') || '';
      ruleData.log_filter = formData.get('log_filter') || '';
    } else {
      ruleData.condition = '';
      ruleData.threshold = 0;
      ruleData.log_pattern = '';
      ruleData.app_filter = '';
      ruleData.log_filter = '';
    }

    try {
      const method = ruleData.id ? 'PUT' : 'POST';
      const url = ruleData.id ? `/api/alerts/rules/${ruleData.id}` : '/api/alerts/rules';
      
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(ruleData)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || response.statusText);
      }
      
      document.getElementById('rule-modal').checked = false;
      await loadAlertRules();
      showToast('Alert rule saved successfully', 'success');
    } catch (e) {
      console.error('Failed to save rule:', e);
      showToast('Failed to save rule: ' + e.message, 'error');
    }
  }

  async function editRule(id) {
    const rule = alertRules.find(r => r.id === id);
    if (!rule) return;
    
    const form = document.getElementById('rule-form');
    
    // Clear form first
    form.reset();
    
    // Set basic fields
    form.querySelector('[name="id"]').value = rule.id;
    form.querySelector('[name="name"]').value = rule.name;
    form.querySelector('[name="description"]').value = rule.description || '';
    form.querySelector('[name="type"]').value = rule.type;
    form.querySelector('[name="severity"]').value = rule.severity;
    form.querySelector('[name="enabled"]').checked = rule.enabled;
    form.querySelector('[name="email_enabled"]').checked = rule.email_enabled;
    
    // Update field visibility first
    updateConditionFields();
    
    // Set type-specific fields after visibility update
    if (rule.type === 'system_metric') {
      form.querySelector('[name="condition"]').value = rule.condition || '';
      form.querySelector('[name="threshold"]').value = rule.threshold || '';
    } else if (rule.type === 'log_pattern' || rule.type === 'exception_detection') {
      form.querySelector('[name="log_pattern"]').value = rule.log_pattern || '';
      form.querySelector('[name="app_filter"]').value = rule.app_filter || '';
      form.querySelector('[name="log_filter"]').value = rule.log_filter || '';
    }
    
    document.getElementById('rule-modal-title').textContent = 'Edit Alert Rule';
    document.getElementById('rule-modal').checked = true;
  }

  async function toggleRule(id, enabled) {
    try {
      const response = await fetch(`/api/alerts/rules/${id}/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
      if (!response.ok) throw new Error(response.statusText);
      await loadAlertRules();
      showToast(`Rule ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
    } catch (e) {
      showToast('Failed to toggle rule: ' + e.message, 'error');
    }
  }

  async function deleteRule(id) {
    if (!confirm('Are you sure you want to delete this alert rule?')) return;
    
    try {
      const response = await fetch(`/api/alerts/rules/${id}`, { method: 'DELETE' });
      if (!response.ok) throw new Error(response.statusText);
      await loadAlertRules();
      showToast('Rule deleted successfully', 'success');
    } catch (e) {
      showToast('Failed to delete rule: ' + e.message, 'error');
    }
  }

  async function resolveAlert(id) {
    try {
      const response = await fetch(`/api/alerts/${id}/resolve`, { method: 'POST' });
      if (!response.ok) throw new Error(response.statusText);
      await loadAlertHistory();
      showToast('Alert resolved', 'success');
    } catch (e) {
      showToast('Failed to resolve alert: ' + e.message, 'error');
    }
  }

  async function testAlert() {
    try {
      const response = await fetch('/api/alerts/test', { method: 'POST' });
      if (!response.ok) throw new Error(response.statusText);
      setTimeout(() => loadAlertHistory(), 500);
      showToast('Test alert sent', 'success');
    } catch (e) {
      showToast('Failed to send test alert: ' + e.message, 'error');
    }
  }

  function updateConditionFields() {
    const typeSelect = document.getElementById('rule-type');
    const systemFields = document.getElementById('system-fields');
    const logFields = document.getElementById('log-fields');
    
    if (!typeSelect || !systemFields || !logFields) return;
    
    const type = typeSelect.value;
    
    // Hide all fields first
    systemFields.classList.add('hidden');
    logFields.classList.add('hidden');
    
    // Show relevant fields based on type
    if (type === 'system_metric') {
      systemFields.classList.remove('hidden');
    } else if (type === 'log_pattern' || type === 'exception_detection') {
      logFields.classList.remove('hidden');
    }
  }

  function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
      pagination.style.display = 'none';
      return;
    }

    pagination.style.display = 'flex';
    pagination.innerHTML = '';

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = `join-item btn btn-sm ${currentPage === 1 ? 'btn-disabled' : ''}`;
    prevBtn.innerHTML = window.innerWidth < 640 ? '‚Äπ' : 'Previous';
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderAlertHistory();
      }
    };
    pagination.appendChild(prevBtn);

    // Page numbers (show fewer on mobile)
    const maxPages = window.innerWidth < 640 ? 3 : 5;
    const startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
    const endPage = Math.min(totalPages, startPage + maxPages - 1);
    
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `join-item btn btn-sm ${i === currentPage ? 'btn-active' : ''}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        currentPage = i;
        renderAlertHistory();
      };
      pagination.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = `join-item btn btn-sm ${currentPage === totalPages ? 'btn-disabled' : ''}`;
    nextBtn.innerHTML = window.innerWidth < 640 ? '‚Ä∫' : 'Next';
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderAlertHistory();
      }
    };
    pagination.appendChild(nextBtn);
  }

  function viewAlertDetails(id) {
    const alertData = alertHistory.find(a => a.id === id);
    if (!alertData) return;
    
    alert(`Alert Details:\n\nType: ${alertData.type}\nSeverity: ${alertData.severity || 'medium'}\nTime: ${new Date(alertData.timestamp).toLocaleString()}\nMessage: ${alertData.message}`);
  }

  // Reset pagination when switching views
  function showHistoryView() {
    currentView = 'history';
    currentPage = 1;
    document.getElementById('history-tab').classList.add('tab-active');
    document.getElementById('rules-tab').classList.remove('tab-active');
    document.getElementById('history-view').classList.remove('hidden');
    document.getElementById('rules-view').classList.add('hidden');
    renderAlertHistory();
  }

  init();
</script>
{{ end }}

{{ block body() }}
<div class="min-h-screen bg-gradient-to-br from-base-200 to-base-300">
  <div class="container mx-auto px-4 lg:px-6 py-4 lg:py-8">
    <!-- Header -->
    <div class="bg-base-100 rounded-2xl shadow-xl p-4 lg:p-8 mb-4 lg:mb-8">
      <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
        <div class="flex items-center gap-3 lg:gap-4">
          <div class="p-2 lg:p-3 bg-primary/10 rounded-xl">
            <svg class="w-6 h-6 lg:w-8 lg:h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl lg:text-3xl font-bold text-base-content">Alert Management</h1>
            <p class="text-base-content/60 mt-1 text-sm lg:text-base">Monitor system metrics, log patterns, and exceptions</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-outline btn-sm gap-2" onclick="testAlert()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <span class="hidden sm:inline">Test Alert</span>
          </button>
          <button class="btn btn-primary btn-sm gap-2" onclick="showCreateRuleModal()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            <span class="hidden sm:inline">Create Rule</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-base-100 rounded-2xl shadow-xl mb-4 lg:mb-8">
      <div class="tabs tabs-boxed tabs-lg w-full bg-base-200">
        <a id="rules-tab" class="tab gap-2 hover:bg-base-300 transition-all text-sm lg:text-base" onclick="showRulesView()">
          <svg class="w-4 h-4 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="hidden sm:inline">Alert Rules</span>
          <span class="sm:hidden">Rules</span>
        </a>
        <a id="history-tab" class="tab tab-active gap-2 hover:bg-base-300 transition-all text-sm lg:text-base" onclick="showHistoryView()">
          <svg class="w-4 h-4 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="hidden sm:inline">Alert History</span>
          <span class="sm:hidden">History</span>
        </a>
      </div>
      
      <!-- Rules View -->
      <div id="rules-view" class="hidden p-4 lg:p-8">
        <div id="rules-container">
          <!-- Rules will be rendered here -->
        </div>
      </div>

      <!-- History View -->
      <div id="history-view" class="p-4 lg:p-8">
        <!-- Mobile Card View -->
        <div class="block lg:hidden space-y-3" id="mobile-alerts">
          <!-- Mobile alert cards will be populated here -->
        </div>
        
        <!-- Desktop Table View -->
        <div class="hidden lg:block overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr class="bg-base-200">
                <th class="font-semibold text-base-content">Time</th>
                <th class="font-semibold text-base-content">Severity</th>
                <th class="font-semibold text-base-content">Type</th>
                <th class="font-semibold text-base-content">Message</th>
                <th class="font-semibold text-base-content">Status</th>
                <th class="font-semibold text-base-content">Actions</th>
              </tr>
            </thead>
            <tbody id="alerts-body">
              <!-- Alert history rows -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex justify-center mt-6">
          <div class="join" id="pagination" style="display: none">
            <!-- Pagination buttons populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Rule Modal -->
<input type="checkbox" id="rule-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto">
    <h3 id="rule-modal-title" class="font-bold text-lg lg:text-xl mb-4 lg:mb-6">Create Alert Rule</h3>
    
    <form id="rule-form" onsubmit="event.preventDefault(); saveRule();">
      <input type="hidden" name="id" id="rule-id">
      
      <!-- Basic Info -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Rule Name *</span>
          </label>
          <input type="text" name="name" class="input input-bordered" required placeholder="e.g., High CPU Alert">
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Severity *</span>
          </label>
          <select name="severity" class="select select-bordered" required>
            <option value="low">üü¢ Low</option>
            <option value="medium" selected>üü° Medium</option>
            <option value="high">üü† High</option>
            <option value="critical">üî¥ Critical</option>
          </select>
        </div>
      </div>
      
      <div class="form-control mb-6">
        <label class="label">
          <span class="label-text font-medium">Description</span>
        </label>
        <textarea name="description" class="textarea textarea-bordered" rows="2" placeholder="Optional description of what this alert monitors"></textarea>
      </div>
      
      <!-- Alert Type -->
      <div class="form-control mb-6">
        <label class="label">
          <span class="label-text font-medium">Alert Type *</span>
        </label>
        <select id="rule-type" name="type" class="select select-bordered" onchange="updateConditionFields()" required>
          <option value="system_metric">üìä System Metric Threshold</option>
          <option value="log_pattern">üìù Log Pattern Match</option>
          <option value="exception_detection">‚ö†Ô∏è Exception Detection</option>
          <option value="service_status">üîß Service Status Change</option>
        </select>
      </div>
      
      <!-- System Metric Fields -->
      <div id="system-fields" class="mb-6">
        <div class="alert alert-info mb-4">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <span class="text-sm">Monitor system metrics and trigger alerts when thresholds are exceeded</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Metric Condition *</span>
            </label>
            <select name="condition" class="select select-bordered">
              <option value="cpu_high">CPU Usage High</option>
              <option value="memory_high">Memory Usage High</option>
              <option value="disk_low">Disk Space Low</option>
              <option value="disk_high">Disk Usage High</option>
            </select>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Threshold Value (%)</span>
            </label>
            <input type="number" name="threshold" class="input input-bordered" step="0.1" min="0" max="100" placeholder="80.0">
          </div>
        </div>
      </div>
      
      <!-- Log Pattern Fields -->
      <div id="log-fields" class="mb-6 hidden">
        <div class="alert alert-warning mb-4">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div class="text-sm">
            <div>Monitor log files for specific patterns or exceptions</div>
            <div class="mt-1 text-xs opacity-75">üí° Use log names from config.yaml (e.g., "Error Log"), not filenames (e.g., "error.log")</div>
          </div>
        </div>
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-medium">Log Pattern (Regex)</span>
          </label>
          <input type="text" name="log_pattern" class="input input-bordered font-mono" placeholder="ERROR|FATAL|Exception|Traceback">
          <label class="label">
            <span class="label-text-alt">Use regex patterns to match log entries. Leave empty for auto-detection in exception mode.</span>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">App Filter</span>
            </label>
            <select name="app_filter" class="select select-bordered">
              <option value="">All Apps</option>
              <option value="System Services">System Services</option>
              <option value="Test App">Test App</option>
              <option value="App One">App One</option>
              <option value="App Two">App Two</option>
            </select>
            <label class="label">
              <span class="label-text-alt">Select which app's logs to monitor</span>
            </label>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Log Source Filter</span>
            </label>
            <input type="text" name="log_filter" class="input input-bordered" placeholder="Error Log, Application Log">
            <label class="label">
              <span class="label-text-alt">Enter the log name from config (not filename). Leave empty to monitor all logs.</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Options -->
      <div class="divider">Options</div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div class="form-control">
          <label class="cursor-pointer label justify-start gap-3">
            <input type="checkbox" name="enabled" class="checkbox checkbox-primary" checked>
            <div>
              <span class="label-text font-medium">Enable this alert rule</span>
              <div class="label-text-alt text-base-content/60">Rule will actively monitor and trigger alerts</div>
            </div>
          </label>
        </div>
        
        <div class="form-control">
          <label class="cursor-pointer label justify-start gap-3">
            <input type="checkbox" name="email_enabled" class="checkbox checkbox-secondary">
            <div>
              <span class="label-text font-medium">Send email notifications</span>
              <div class="label-text-alt text-base-content/60">Email alerts when rule triggers</div>
            </div>
          </label>
        </div>
      </div>
      
      <div class="modal-action">
        <label for="rule-modal" class="btn btn-ghost">Cancel</label>
        <button type="submit" class="btn btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Save Rule
        </button>
      </div>
    </form>
  </div>
</div>
{{ end }}